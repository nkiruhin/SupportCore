@model IEnumerable<SupportCore.Models.SLA>

@foreach (var item in Model)
{
    //string wbutton = "";
    //if (item.Type == "select")
    //{
    //    wbutton = "wbutton";
    //}

<form class="tr" asp-action="SaveField" asp-route-id="@item.Id" id="@item.Id"
      data-ajax="true"
      data-ajax-method="POST"
      data-ajax-success="disabledInput(@item.Id)">
    <div class="td"><input asp-for="@item.Name" disabled /></div>
    @if (item.CategoryId != null)
    {
        <div class="td" style="width:20%">
            <select disabled>
                <option>Категория</option>
            </select>
        </div>
        <div class="td" style="width:40%">
            <select asp-for="@item.CategoryId" asp-items="@ViewBag.CategoryId" disabled">
                <option>Выберите из списка</option>
            </select>
        </div>
    }
    else
    {
        <div class="td" style="width:20%">
            <select asp-for="@item.FieldId" data-row-id="@item.Id" asp-items="@ViewBag.FieldId" disabled onchange="GetValue(this)">
                <option>Выберите из списка</option>
            </select>
        </div>
        <div class="td" style="width:20%">
            <select asp-for="@item.FieldValue" data-value-id="@item.Id" disabled>
                <option selected>@item.FieldValue</option>
            </select>
        </div>
    }
    <div class="td"><input asp-for="@item.ResponseTime" disabled /></div>
    <div class="td"><input asp-for="@item.DeadTime" disabled /></div>
    @{  string check = "checked";
        if (item.CategoryId != null) { check = ""; }
    }
    <div class="td"><input type="checkbox" data-role="switch" disabled @check /></div>
    <div class="td" style="width:10%">
        <div data-role="buttongroup">
            <a asp-action="FieldDelete" asp-route-id="@item.Id"
               data-ajax="true"
               data-ajax-method="POST"
               data-ajax-update="#Fields"
               data-ajax-mode="update"
               class="tool-button" data-role="button"><span class="mif-bin"></span></a>
            <button class="tool-button edit" data-fid="@item.FieldId" data-row-id="@item.Id"><span class="mif-pencil"></span></button>
            <button class="tool-button save" style="display:none"><span class="mif-floppy-disk"></span></button>
        </div>
    </div>
</form>}

<script>
   $(document).ready(function () {
        
    })
    $('.edit').on('click', function () {
        var input = $(this).parent().parent().parent().find(':input');
        var isField = $(this).parent().parent().prev().find(':input').is(':checked'); 
        input.prop('disabled', false);
        submitButton = $(this).next();
        submitButton.show();
        $(this).hide();
        if (isField) {
            var fieldId = $(this).data('fid');
            var rowId = $(this).data('row-id');
            var selector = '*[data-value-id="' + rowId + '"]';
            var selected = $(selector).val();
            console.log($(selector).val());      
            var url = '@Url.Action("GetValues")' + '?FieldId=' + fieldId;
            var option = '';
            console.log(url);
            $.getJSON(url, function (data) {
                $.each(data, function (i, value) {
                    if (value === selected) { sel = 'selected' } else sel='';
                    option += '<option '+sel+' value="' + value + '">' + value + '</option>';
                })
                $(selector).html(option);
            });
        }
        return false;
    })
    $('.save').on('click', function () {
        var input = $(this).parent().parent().parent().find(':input');
        editButton = $(this).prev();
        //console.log(editButton);
        editButton.show();
        $(this).hide();
    })
    function disabledInput(id) {
        var input = $('#' + id).find(':input:not(:button)');
        input.prop('disabled', true);
        onSuccess('Сохранено');
    }
</script>
